import { getContext } from "../../../extensions.js";

const CTEEscape = {
    settings: {
        theme: 0, // 0:é»‘é‡‘, 1:è“ç™½, 2:ç²‰ç™½
    },
    panelLoaded: false,

    async init() {
        console.log("[CTE Esport] æ’ä»¶å¯åŠ¨ä¸­...");
        
        // 1. æ³¨å…¥æŒ‰é’® (å…ˆè®©æŒ‰é’®æ˜¾ç¤ºå‡ºæ¥)
        this.injectToggleButton();
        
        // 2. åŠ è½½ HTML (å…³é”®ä¿®å¤ï¼šä½¿ç”¨ç›¸å¯¹è·¯å¾„)
        await this.loadHTML();
        
        // 3. å¦‚æžœ HTML åŠ è½½æˆåŠŸï¼Œç»‘å®šäº‹ä»¶å¹¶åŠ è½½è®¾ç½®
        if (this.panelLoaded) {
            this.loadSettings();
            this.bindEvents();
            this.applyTheme(this.settings.theme);
            console.log("[CTE Esport] åˆå§‹åŒ–å®Œæ¯•ï¼Œå‡†å¤‡å°±ç»ªã€‚");
        } else {
            console.error("[CTE Esport] HTML åŠ è½½å¤±è´¥ï¼Œæ’ä»¶åŠŸèƒ½å°†ä¸å¯ç”¨ã€‚");
        }
    },

    async loadHTML() {
        try {
            // å…³é”®ä¿®æ”¹ï¼šä¸å†çŒœæµ‹æ–‡ä»¶å¤¹åå­—ï¼Œç›´æŽ¥èŽ·å–å½“å‰è„šæœ¬æ—è¾¹çš„ map.html
            const panelUrl = new URL('./map.html', import.meta.url).href;
            console.log(`[CTE Esport] æ­£åœ¨åŠ è½½é¢æ¿æ–‡ä»¶: ${panelUrl}`);

            const response = await fetch(panelUrl);
            if (!response.ok) throw new Error(`HTTP Error ${response.status}: ${response.statusText}`);
            
            const html = await response.text();
            
            // æ³¨å…¥åˆ° DOM
            const container = document.createElement("div");
            container.innerHTML = html;
            document.body.appendChild(container.firstElementChild);
            
            this.panelLoaded = true;
            console.log("[CTE Esport] é¢æ¿ DOM å·²æ³¨å…¥ã€‚");
        } catch (e) {
            console.error("[CTE Esport] æ— æ³•åŠ è½½ map.html:", e);
            if (typeof toastr !== "undefined") {
                toastr.error("CTEåœ°å›¾æ–‡ä»¶ä¸¢å¤±æˆ–è·¯å¾„é”™è¯¯ï¼Œè¯·æŒ‰ F12 æŸ¥çœ‹æŽ§åˆ¶å°ã€‚", "åŠ è½½å¤±è´¥");
            }
        }
    },

    injectToggleButton() {
        if (document.getElementById("cte-esport-toggle-btn")) return;

        const btn = document.createElement("div");
        btn.id = "cte-esport-toggle-btn";
        btn.innerHTML = "ðŸ†"; 
        btn.title = "æ‰“å¼€ CTE æˆ˜é˜Ÿåœ°å›¾";
        // æ ·å¼ï¼šz-index è®¾ä¸ºæžé«˜ï¼Œç¡®ä¿å¤„äºŽé¡¶å±‚
        btn.style.cssText = `
            position: fixed; 
            top: 10px; 
            right: 340px; 
            z-index: 2147483647; 
            font-size: 24px; 
            cursor: pointer; 
            filter: drop-shadow(0 0 2px black);
            transition: transform 0.2s;
            user-select: none;
        `;
        
        btn.addEventListener("click", (e) => {
            e.stopPropagation(); // é˜²æ­¢äº‹ä»¶å†’æ³¡
            this.togglePanel();
        });
        
        btn.addEventListener("mouseover", () => btn.style.transform = "scale(1.1)");
        btn.addEventListener("mouseout", () => btn.style.transform = "scale(1)");
        
        document.body.appendChild(btn);
    },

    togglePanel() {
        const panel = document.getElementById("cte-esport-panel");
        
        if (!panel) {
            // å¦‚æžœé¢æ¿ä¸å­˜åœ¨ï¼ˆæ¯”å¦‚ map.html æ²¡åŠ è½½æˆåŠŸï¼‰ï¼Œæç¤ºç”¨æˆ·
            console.error("[CTE Esport] é”™è¯¯ï¼šæ‰¾ä¸åˆ°é¢æ¿å…ƒç´  #cte-esport-panel");
            if (typeof toastr !== "undefined") {
                toastr.warning("åœ°å›¾é¢æ¿æœªèƒ½æˆåŠŸåŠ è½½ï¼Œè¯·å°è¯•åˆ·æ–°é¡µé¢ã€‚", "é”™è¯¯");
            }
            return;
        }

        const currentDisplay = window.getComputedStyle(panel).display;
        if (currentDisplay === "none") {
            panel.style.display = "flex";
            // åŠ¨ç”»æ•ˆæžœ
            panel.style.opacity = "0";
            panel.style.transform = "translate(-50%, -45%)";
            requestAnimationFrame(() => {
                panel.style.transition = "opacity 0.3s, transform 0.3s";
                panel.style.opacity = "1";
                panel.style.transform = "translate(-50%, -50%)";
            });
        } else {
            panel.style.display = "none";
        }
    },

    bindEvents() {
        const panel = document.getElementById("cte-esport-panel");
        if (!panel) return;

        // å…³é—­æŒ‰é’®
        const closeBtn = panel.querySelector("#cte-btn-close");
        if(closeBtn) closeBtn.addEventListener("click", () => this.togglePanel());

        // ä¸»é¢˜åˆ‡æ¢
        const themeBtn = panel.querySelector("#cte-btn-theme");
        if(themeBtn) themeBtn.addEventListener("click", () => {
            this.settings.theme = (this.settings.theme + 1) % 3;
            this.applyTheme(this.settings.theme);
            this.saveSettings();
        });

        // ç‚¹å‡»åœ°å›¾èƒŒæ™¯å…³é—­æ‰€æœ‰å¼¹çª— (ä½†æŽ’é™¤åœ°æ ‡ç‚¹)
        const mapCanvas = panel.querySelector("#cte-map-canvas");
        if(mapCanvas) {
            mapCanvas.addEventListener("click", (e) => {
                if (e.target.id === "cte-map-canvas") {
                    this.closeAllPopups();
                }
            });
        }

        // åœ°æ ‡ç‚¹å‡»ä»£ç†
        if(mapCanvas) {
            mapCanvas.addEventListener("click", (e) => {
                const pin = e.target.closest(".cte-esport-pin");
                if (pin) {
                    e.stopPropagation();
                    const popupId = pin.getAttribute("data-popup");
                    this.showPopup(popupId);
                }
            });
        }

        // å¼¹çª—å†…éƒ¨ç‚¹å‡»å¤„ç† (å§”æ‰˜åœ¨ panel ä¸Š)
        panel.addEventListener("click", (e) => {
            const target = e.target;
            
            // å…³é—­å°å¼¹çª—
            if (target.matches(".cte-close-btn")) {
                const popup = target.closest(".cte-esport-popup");
                if(popup) popup.classList.remove("active");
            }

            // å‰å¾€ (Travel)
            const travelDest = target.getAttribute("data-travel") || target.closest("[data-travel]")?.getAttribute("data-travel");
            if (travelDest) {
                this.handleTravel(travelDest);
            }

            // å†…éƒ¨åŠŸèƒ½æŒ‰é’®
            if (target.getAttribute("data-action") === "interior") this.showPopup("popup-interior");
            if (target.getAttribute("data-action") === "back-base") this.showPopup("popup-cte");

            // æ¥¼å±‚åˆ‡æ¢
            const floorBtn = target.closest(".cte-floor-btn");
            if (floorBtn) {
                const floorId = floorBtn.getAttribute("data-target");
                this.toggleFloor(floorId, floorBtn);
            }
        });

        // è‡ªå®šä¹‰å‰å¾€
        const customBtn = document.getElementById("cte-btn-custom-go");
        if (customBtn) {
            customBtn.addEventListener("click", () => {
                const input = document.getElementById("cte-custom-input");
                if (input && input.value.trim()) this.handleTravel(input.value.trim());
            });
        }
    },

    showPopup(id) {
        this.closeAllPopups();
        const popup = document.getElementById(id);
        if (popup) popup.classList.add("active");
    },

    closeAllPopups() {
        document.querySelectorAll(".cte-esport-popup").forEach(p => p.classList.remove("active"));
    },

    toggleFloor(floorId, btn) {
        const panel = document.getElementById(floorId);
        if(!panel) return;

        // é‡ç½®å…¶ä»–
        document.querySelectorAll(".cte-floor-panel").forEach(p => {
            if(p.id !== floorId) p.style.display = "none";
        });
        document.querySelectorAll(".cte-floor-btn").forEach(b => b.classList.remove("active"));

        // åˆ‡æ¢å½“å‰
        if (panel.style.display === "block") {
            panel.style.display = "none";
            btn.classList.remove("active");
        } else {
            panel.style.display = "block";
            btn.classList.add("active");
        }
    },

    handleTravel(destination) {
        this.togglePanel(); // å…³é—­åœ°å›¾
        
        // å‘é€ç»™ ST
        const context = getContext();
        const textarea = document.getElementById('send_textarea');
        if (textarea) {
            textarea.value = `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·å‰å¾€äº†â€œ${destination}â€ã€‚è¯·æ ¹æ®å½“å‰ä½ç½®æè¿°çŽ¯å¢ƒã€‚]`;
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
        }

        if (typeof toastr !== 'undefined') {
            toastr.success(`æ­£åœ¨å‰å¾€ï¼š${destination}`);
        }
    },

    applyTheme(theme) {
        const root = document.getElementById("cte-esport-root");
        if (!root) return;
        
        const themes = [
            { bg: '#121212', panel: '#1e1e1e', gold: '#c5a065', text: '#e0e0e0' }, // é»‘é‡‘
            { bg: '#f4f7f6', panel: '#ffffff', gold: '#5d9cec', text: '#333333' }, // è“ç™½
            { bg: '#fff0f3', panel: '#ffffff', gold: '#f06292', text: '#4a2c36' }  // ç²‰ç™½
        ];
        
        const t = themes[theme] || themes[0];
        root.style.setProperty('--cte-bg-dark', t.bg);
        root.style.setProperty('--cte-panel-bg', t.panel);
        root.style.setProperty('--cte-accent-gold', t.gold);
        root.style.setProperty('--cte-text-main', t.text);
    },

    saveSettings() {
        localStorage.setItem("cte-esport-settings", JSON.stringify(this.settings));
    },

    loadSettings() {
        const data = localStorage.getItem("cte-esport-settings");
        if (data) {
            try { this.settings = JSON.parse(data); } catch(e){}
        }
    }
};

// ç¡®ä¿åœ¨ jQuery å°±ç»ªåŽæ‰§è¡Œ
if (typeof jQuery !== 'undefined') {
    jQuery(async () => await CTEEscape.init());
} else {
    // åŽå¤‡æ–¹æ¡ˆ
    document.addEventListener('DOMContentLoaded', async () => await CTEEscape.init());
}
